#!/bin/bash
set -o pipefail

#
# Purpose: Check if there is a legacy Apple Time Capsule in your network and mount it
#     for use it under Gnu/Linux or macOS. Unmount it if it is already mounted.
#          The mount point is created and destroyed after use (for prevent
#          automatic backup software to backup in the directory if the device
#          is not mounted)
# Note: Apple discontinued Time Capsule in 2018. This script is for legacy hardware.
# Instructions:
#   1) For Linux: Install cifs-utils (sudo apt-get install cifs-utils)
#      For macOS: No additional packages needed
#   2) For Linux: Install Dolphin or change to your preferred file manager
#      For macOS: Uses Finder
#   3) Set environment variables or use command-line options for configuration
#   4) Run this program at boot when your network is already
#   set up. Also, run it on logoff to umount Time Capsule.
#   Run it as root (in kde you can prefix the command via kdesu)

TIMECAPSULE_IP="${TIMECAPSULE_IP:-192.168.0.3}"                         # e.g. "192.168.1.100"
TIMECAPSULE_VOLUME="${TIMECAPSULE_VOLUME:-/Data}"       # also try "/Data"
# Credentials are read from environment variables: TIMECAPSULE_USER and TIMECAPSULE_PASS
TIMECAPSULE_USERNAME="${TIMECAPSULE_USER:-}"
TIMECAPSULE_PASSWORD="${TIMECAPSULE_PASS:-Superuser}"
MOUNT_POINT="${TIMECAPSULE_MOUNT_POINT:-$HOME/TimeCapsule}"               # no need to create the directory

UMOUNT_MODE=false

# Parse long options
while [ $# -gt 0 ]; do
    case $1 in
        --umount)
            UMOUNT_MODE=true
            shift
            ;;
        --*)
            echo "Unknown option: $1" >&2
            exit 1
            ;;
        *)
            break
            ;;
    esac
done

# Parse command-line options
while getopts "i:v:u:p:m:" opt; do
    case $opt in
        i) TIMECAPSULE_IP="$OPTARG" ;;
        v) TIMECAPSULE_VOLUME="$OPTARG" ;;
        u) TIMECAPSULE_USERNAME="$OPTARG" ;;
        p) TIMECAPSULE_PASSWORD="$OPTARG" ;;
        m) MOUNT_POINT="$OPTARG" ;;
        *) echo "Usage: $0 [-i IP] [-v VOLUME] [-u USERNAME] [-p PASSWORD] [-m MOUNT_POINT] [--umount]" >&2; exit 1 ;;
    esac
done

TIMECAPSULE_PATH="$TIMECAPSULE_IP$TIMECAPSULE_VOLUME"
USERS=$(users)
for USER in $USERS
do
        CURRENTUSER=$USER
done
OS=$(uname)
if [ "$OS" = "Linux" ]; then
    SUDO="sudo -H -u $CURRENTUSER bash -c"
    if command -v dolphin > /dev/null 2>&1; then
        FILE_MANAGER="dolphin"
    else
        FILE_MANAGER="xdg-open"
    fi
    if command -v notify-send > /dev/null 2>&1; then
        NOTIFY_CMD="notify-send"
    else
        NOTIFY_CMD="echo"
    fi
elif [ "$OS" = "Darwin" ]; then
    SUDO="sudo -u $CURRENTUSER bash -c"
    FILE_MANAGER="open"
else
    echo "Unsupported OS: $OS"
    exit 1
fi

notify() {
    if [ "$OS" = "Linux" ]; then
        $NOTIFY_CMD "$1"
    elif [ "$OS" = "Darwin" ]; then
        osascript -e "display notification \"$1\" with title \"Time Capsule\""
    fi
}

file_manager() {
    if [ "$OS" = "Linux" ]; then
        $SUDO "$FILE_MANAGER" "$1" > /dev/null 2>&1 &
    elif [ "$OS" = "Darwin" ]; then
        $SUDO "$FILE_MANAGER" "$1"
    fi
}

if $UMOUNT_MODE; then
    if mount 2>/dev/null | grep -q "$MOUNT_POINT"; then
        if [ "$OS" = "Linux" ]; then
            if [ "$FILE_MANAGER" = "dolphin" ]; then
                killall dolphin > /dev/null 2>&1
            fi
            fusermount -u -z "$MOUNT_POINT"
        else
            sudo umount "$MOUNT_POINT"
        fi
        rmdir "$MOUNT_POINT"
        notify "Network disk has been safely unmounted"
    else
        echo "Time Capsule is not mounted at $MOUNT_POINT."
    fi
else
    if mount 2>/dev/null | grep -q "$MOUNT_POINT"; then
        echo "Time Capsule is already mounted at $MOUNT_POINT."
    else
        mkdir -p "$MOUNT_POINT"
        if [ "$OS" = "Linux" ]; then
            # Use AFP for mounting on Linux
            AFP_VOLUME="${TIMECAPSULE_VOLUME#/}"
            if mount_afp "afp://$TIMECAPSULE_USERNAME:$TIMECAPSULE_PASSWORD@$TIMECAPSULE_IP/$AFP_VOLUME" "$MOUNT_POINT"; then
                notify "Network disk has been mounted."
                $SUDO "$FILE_MANAGER" "$MOUNT_POINT" > /dev/null 2>&1 &
            else
                rmdir "$MOUNT_POINT"
                echo "Failed to mount Time Capsule via AFP." >&2
                exit 1
            fi
        elif [ "$OS" = "Darwin" ]; then
            if mount_smbfs //"$TIMECAPSULE_USERNAME:$TIMECAPSULE_PASSWORD@$TIMECAPSULE_PATH" "$MOUNT_POINT"; then
                notify "Network disk has been mounted"
                $SUDO "$FILE_MANAGER" "$MOUNT_POINT"
            else
                rmdir "$MOUNT_POINT"
                echo "Failed to mount Time Capsule via SMB." >&2
                exit 1
            fi
        fi
    fi
fi
exit 0
