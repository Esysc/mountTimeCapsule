#!/bin/bash
set -o pipefail

#
# Purpose: Check if there is a legacy Apple Time Capsule in your network and mount it
#     for use it under Gnu/Linux or macOS. Unmount it if it is already mounted.
#          The mount point is created and destroyed after use (for prevent
#          automatic backup software to backup in the directory if the device
#          is not mounted)
# Note: Apple discontinued Time Capsule in 2018. This script is for legacy hardware.
# Instructions:
#   1) For Linux: Install Vagrant and VirtualBox
#   2) For Linux: Install Dolphin or change to your preferred file manager
#      For macOS: Uses Finder
#   3) Set environment variables or use command-line options for configuration
#   4) Run this program at boot when your network is already set up. Also, run it on logoff to umount Time Capsule.
#   Run it as root (in kde you can prefix the command via kdesu)

TIMECAPSULE_IP="${TIMECAPSULE_IP:-192.168.0.3}"
TIMECAPSULE_VOLUME="${TIMECAPSULE_VOLUME:-Data}"
TIMECAPSULE_USERNAME="${TIMECAPSULE_USER:-Superuser}"
TIMECAPSULE_PASSWORD="${TIMECAPSULE_PASS:-Superuser}"
MOUNT_POINT="${TIMECAPSULE_MOUNT_POINT:-$HOME/TimeCapsule}"
OS=$(uname)
UMOUNT_MODE=false

# Parse command-line options
while [ $# -gt 0 ]; do
    case $1 in
        -i) TIMECAPSULE_IP="$2"; shift 2 ;;
        -v) TIMECAPSULE_VOLUME="$2"; shift 2 ;;
        -u) TIMECAPSULE_USERNAME="$2"; shift 2 ;;
        -p) TIMECAPSULE_PASSWORD="$2"; shift 2 ;;
        -m) MOUNT_POINT="$2"; shift 2 ;;
        --umount) UMOUNT_MODE=true; shift ;;
        --help)
            echo "Usage: $0 [OPTIONS]"
            echo "  -i IP      Time Capsule IP (default: 192.168.0.3)"
            echo "  -v VOLUME  Share name (default: Data)"
            echo "  -u USER    Username (default: Superuser)"
            echo "  -p PASS    Password (default: Superuser)"
            echo "  -m PATH    Mount point (default: ~/TimeCapsule)"
            echo "  --umount   Unmount instead"
            exit 0
            ;;
        *) echo "Unknown option: $1. Use --help"; exit 1 ;;
    esac
done

notify() {
    if [ "$OS" = "Linux" ] && command -v notify-send >/dev/null; then
        notify-send "$1"
    elif [ "$OS" = "Darwin" ]; then
        osascript -e "display notification \"$1\" with title \"Time Capsule\""
    else
        echo "$1"
    fi
}

file_manager() {
    if [ "$OS" = "Linux" ]; then
        if command -v dolphin >/dev/null; then dolphin "$1" > /dev/null 2>&1 & fi
    elif [ "$OS" = "Darwin" ]; then
        open "$1"
    fi
}

# Return success if the Time Capsule appears mounted anywhere (by mount
# point, share name, or IP). Useful to avoid re-running expensive mount
# flows on either Linux or macOS.
is_mounted() {
    if mount | grep -q "$MOUNT_POINT"; then
        echo "$MOUNT_POINT is already in mounts list."
        return 0
    fi
    if [ -n "$TIMECAPSULE_VOLUME" ] && mount | grep -q "$TIMECAPSULE_VOLUME"; then
        echo "$TIMECAPSULE_VOLUME is already in mounts list."
        return 0
    fi
    if [ -n "$TIMECAPSULE_IP" ] && mount | grep -q "$TIMECAPSULE_IP"; then
        echo "$TIMECAPSULE_IP is already in mounts list."
        return 0
    fi
    return 1
}

# Return success only if the specified mount point is mounted on this host.
is_mounted_point() {
    mount | awk '{print $3}' | grep -Fxq "$MOUNT_POINT"
}

# Return success if the configured IP responds to a single ping.
# Uses a short timeout so the script doesn't block long when the host is down.
is_reachable() {
    if [ -z "$TIMECAPSULE_IP" ]; then
        return 1
    fi
    echo "Checking $TIMECAPSULE_IP..."
    # Use platform-friendly ping options: on macOS use -W as milliseconds isn't available,
    # so use -c 1 with -t for timeout on Darwin is not available; keep portable by
    # trying the common options and falling back.
    if ping -c 1 -W 2 "$TIMECAPSULE_IP" >/dev/null 2>&1; then
        return 0
    fi
    if ping -c 1 -t 2 "$TIMECAPSULE_IP" >/dev/null 2>&1; then
        return 0
    fi
    if ping -c 1 "$TIMECAPSULE_IP" >/dev/null 2>&1; then
        return 0
    fi
    echo "❌ $TIMECAPSULE_IP unreachable" >&2
    exit 1
}

case "$OS" in
    Linux)
        if $UMOUNT_MODE; then
            echo "Unmount requested. Cleaning mounts and destroying Vagrant VM..."
            # Try to unmount the host-side re-share first
                if is_mounted_point; then
                    echo "Unmounting host mount $MOUNT_POINT..."
                    sudo umount "$MOUNT_POINT" 2>/dev/null || true
                    rmdir "$MOUNT_POINT" 2>/dev/null || true
                else
                    echo "Host mount $MOUNT_POINT not mounted"
                fi

            # Destroy the VM to fully clean up the environment
            echo "Destroying Vagrant VM (this will remove the VM)..."
            vagrant destroy -f || true
            notify "Time Capsule VM destroyed and mounts cleaned"
            echo "Vagrant VM destroyed and mounts cleaned"
        else
            if is_mounted; then
                echo "Time Capsule appears already mounted; skipping mount operations."
                exit 0
            else
                is_reachable
                echo "Mounting at $MOUNT_POINT..."
                mkdir -p "$MOUNT_POINT"
                chmod -R 777 "$MOUNT_POINT" 2>/dev/null || true
                if ! command -v vagrant >/dev/null 2>&1; then
                    echo "Vagrant not installed. Install Vagrant and VirtualBox." >&2
                    exit 1
                fi
                if ! vagrant status | grep -q running; then
                    echo "Starting Vagrant VM..."
                    export MOUNT_POINT="$MOUNT_POINT"
                    vagrant up
                fi
                smb_options="username=$TIMECAPSULE_USERNAME,password=$TIMECAPSULE_PASSWORD,vers=1.0,sec=ntlm,uid=1000,gid=1000"
                VM_SUBDIR="${TIMECAPSULE_VOLUME}"
                VM_MOUNT_DIR="/home/vagrant/mnt/${VM_SUBDIR}"
                mount_cmd="mkdir -p ${VM_MOUNT_DIR} && sudo mount.cifs //$TIMECAPSULE_IP/$TIMECAPSULE_VOLUME ${VM_MOUNT_DIR} -o ${smb_options}"
                if vagrant ssh -c "sudo $mount_cmd"; then
                    notify "✅ Time Capsule mounted in VM at ${VM_MOUNT_DIR} (SMBv1)"
                    echo "✅ VM mounted at ${VM_MOUNT_DIR}; host synced folder is $MOUNT_POINT"
                    echo "Configuring Samba share in VM..."
                    SHARE_NAME="timecapsule"
                    vagrant ssh -c "sudo systemctl restart smbd || sudo service smbd restart" -- -q
                    # VM_IP matched to Vagrantfile configuration
                    VM_IP="192.168.56.10"
                    echo "Mounting VM share //$VM_IP/${SHARE_NAME} on host $MOUNT_POINT..."
                    if sudo mount.cifs "//$VM_IP/${SHARE_NAME}" "$MOUNT_POINT" -o vers=3.0,guest,uid="$(id -u)",gid="$(id -g)",file_mode=0777,dir_mode=0777,iocharset=utf8; then
                        notify "✅ Time Capsule re-shared from VM and mounted on host"
                        file_manager "$MOUNT_POINT"
                        echo "✅ Mounted host from VM at $MOUNT_POINT"
                    else
                        echo "Failed to mount VM share on host. You can access files in the VM at ${VM_MOUNT_DIR}." >&2
                    fi
                else
                    echo "❌ Vagrant SMBv1 mount failed" >&2
                    exit 1
                fi
            fi
        fi
        ;;
    Darwin)
        if $UMOUNT_MODE; then
                if is_mounted_point; then
                    echo "Unmounting $MOUNT_POINT..."
                    diskutil unmount force "$MOUNT_POINT" 2>/dev/null || true
                    rmdir "$MOUNT_POINT" 2>/dev/null || true
                    notify "Time Capsule unmounted"
                    echo "Unmounted successfully"
                else
                    echo "Not mounted at $MOUNT_POINT"
                fi
        else
            if is_mounted; then
                echo "Time Capsule appears already mounted; skipping mount operations."
                exit 0
            else
                echo "Checking $TIMECAPSULE_IP..."
                is_reachable
                echo "Mounting at $MOUNT_POINT..."
                mkdir -p "$MOUNT_POINT"
                TIMECAPSULE_PATH="$TIMECAPSULE_IP/$TIMECAPSULE_VOLUME"
                if mount_smbfs "//$TIMECAPSULE_USERNAME:$TIMECAPSULE_PASSWORD@$TIMECAPSULE_PATH" "$MOUNT_POINT"; then
                    notify "✅ Time Capsule mounted"
                    file_manager "$MOUNT_POINT"
                    echo "✅ Mounted at $MOUNT_POINT"
                else
                    echo "❌ Mount failed" >&2
                    exit 1
                fi
            fi
        fi
        ;;
    *)
        echo "Unsupported OS: $OS" >&2
        exit 1
        ;;
esac

exit 0
